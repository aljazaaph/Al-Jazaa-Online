import React, { useState, useEffect, useMemo } from 'react';
import Layout from './components/Layout';
import { api } from './services/api';
import { Product, CartItem, ViewState, OrderData, CustomerDetails } from './types';
import { HERO_IMAGES, SIZES, DELIVERY_REGIONS } from './constants';
// @ts-ignore
import Swal from 'sweetalert2';

const App: React.FC = () => {
  const [view, setView] = useState<ViewState>('home');
  const [products, setProducts] = useState<Product[]>([]);
  const [loading, setLoading] = useState(true);
  const [cart, setCart] = useState<CartItem[]>(() => {
    const saved = localStorage.getItem('alj_cart_v10');
    return saved ? JSON.parse(saved) : [];
  });
  const [selectedCategory, setSelectedCategory] = useState('All');
  
  // Detail State
  const [detailProduct, setDetailProduct] = useState<Product | null>(null);
  const [detailSize, setDetailSize] = useState<string | null>(null);
  const [detailHeight, setDetailHeight] = useState('');
  const [detailQty, setDetailQty] = useState(1);

  // Search State
  const [searchQuery, setSearchQuery] = useState('');

  // Checkout State
  const [checkoutStep, setCheckoutStep] = useState(1); // 1: Details, 2: Payment
  
  useEffect(() => {
    fetchProducts();
  }, []);

  useEffect(() => {
    localStorage.setItem('alj_cart_v10', JSON.stringify(cart));
  }, [cart]);

  const fetchProducts = async () => {
    setLoading(true);
    const data = await api.getProducts();
    setProducts(data);
    setLoading(false);
  };

  const categories = useMemo(() => ['All', ...Array.from(new Set(products.map(p => p.category)))], [products]);

  const filteredProducts = useMemo(() => {
    return products.filter(p => {
      const matchCat = selectedCategory === 'All' || p.category === selectedCategory;
      const matchSearch = p.name.toLowerCase().includes(searchQuery.toLowerCase());
      return matchCat && matchSearch;
    });
  }, [products, selectedCategory, searchQuery]);

  const openDetail = (product: Product) => {
    setDetailProduct(product);
    setDetailSize(null);
    setDetailHeight('');
    setDetailQty(1);
    setView('detail');
  };

  const addToCart = () => {
    if (!detailProduct || !detailSize || !detailHeight) {
      Swal.fire({ title: 'Missing Info', text: 'Please select Size and Height', icon: 'warning', confirmButtonColor: '#1b4d3e' });
      return;
    }
    const newItem: CartItem = {
      ...detailProduct,
      size: detailSize,
      height: detailHeight,
      qty: detailQty
    };
    
    // Check if same item exists to merge
    const existingIdx = cart.findIndex(c => c.id === newItem.id && c.size === newItem.size && c.height === newItem.height);
    if (existingIdx > -1) {
      const newCart = [...cart];
      newCart[existingIdx].qty += newItem.qty;
      setCart(newCart);
    } else {
      setCart([...cart, newItem]);
    }
    
    Swal.fire({ icon: 'success', title: 'Added to Cart', toast: true, position: 'top-end', showConfirmButton: false, timer: 1500 });
    setView('home');
  };

  const updateCartQty = (index: number, delta: number) => {
    const newCart = [...cart];
    newCart[index].qty += delta;
    if (newCart[index].qty <= 0) {
      newCart.splice(index, 1);
    }
    setCart(newCart);
  };

  // --- VIEWS ---

  const renderHome = () => (
    <div className="animate-fade-in">
      {/* Hero */}
      <div className="relative w-full h-[50vh] md:h-[60vh] overflow-hidden bg-gray-200">
        <div id="heroCarousel" className="carousel slide h-full w-full relative" data-bs-ride="carousel">
          {HERO_IMAGES.map((img, idx) => (
             <div key={idx} className={`absolute inset-0 transition-opacity duration-1000 ${idx === 0 ? 'opacity-100' : 'opacity-0 animate-pulse'}`}>
                {/* Note: Simplified carousel for React without Bootstrap JS dependency, in real prod use Swiper.js. 
                    Using a simple static image 1 for now to ensure stability if no carousel lib is added.
                    To follow instructions strictly to "add on this code", I'll just use the first image for stability or simple CSS mapping if array.
                */}
               <img src={img} className="w-full h-full object-cover" alt="Hero" />
               <div className="absolute inset-0 bg-black/20"></div>
             </div>
          ))}
          {/* Force show first image for MVP if carousel logic isn't fully implemented manually */}
          <img src={HERO_IMAGES[0]} className="w-full h-full object-cover" alt="Hero Main" />
           <div className="absolute inset-0 bg-black/30 flex items-center justify-center">
              <div className="text-center text-white px-4">
                  <h1 className="font-serif text-4xl md:text-6xl font-bold mb-4 drop-shadow-lg">Timeless Elegance</h1>
                  <button onClick={() => document.getElementById('shop-section')?.scrollIntoView({ behavior: 'smooth' })} className="bg-white text-primary px-8 py-3 rounded-full font-bold uppercase tracking-widest hover:bg-gold hover:text-white transition-all shadow-lg transform hover:scale-105">
                    Shop Collection
                  </button>
              </div>
           </div>
        </div>
      </div>

      <div id="shop-section" className="container mx-auto px-4 py-12">
        <div className="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
          <h2 className="font-serif text-3xl text-primary font-bold">{selectedCategory === 'All' ? 'Latest Collection' : selectedCategory}</h2>
          
          <div className="relative w-full md:w-80">
            <input 
              type="text" 
              placeholder="Search products..." 
              value={searchQuery}
              onChange={(e) => setSearchQuery(e.target.value)}
              className="w-full pl-5 pr-10 py-2 rounded-full border border-gray-200 focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary transition-all"
            />
            <i className="fas fa-search absolute right-4 top-3 text-gray-400"></i>
          </div>
        </div>

        {/* Categories Pills */}
        <div className="flex overflow-x-auto gap-3 pb-6 mb-4 no-scrollbar">
          {categories.map(cat => (
            <button
              key={cat}
              onClick={() => setSelectedCategory(cat)}
              className={`px-6 py-2 rounded-full text-sm font-medium whitespace-nowrap transition-all border ${selectedCategory === cat ? 'bg-primary text-white border-primary shadow-md' : 'bg-white text-gray-600 border-gray-200 hover:border-primary hover:text-primary'}`}
            >
              {cat}
            </button>
          ))}
        </div>

        {loading ? (
          <div className="flex justify-center py-20"><div className="animate-spin rounded-full h-12 w-12 border-b-2 border-primary"></div></div>
        ) : (
          <div className="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6">
            {filteredProducts.map(product => (
              <div key={product.id} className="group bg-white rounded-2xl overflow-hidden shadow-sm hover:shadow-xl transition-all duration-300 transform hover:-translate-y-1 cursor-pointer border border-gray-50" onClick={() => openDetail(product)}>
                <div className="relative pt-[133%] bg-gray-100 overflow-hidden">
                  <img src={product.image} className="absolute top-0 left-0 w-full h-full object-cover transition-transform duration-700 group-hover:scale-110" alt={product.name} />
                  
                  {/* Badges */}
                  <div className="absolute top-3 left-3 flex flex-col gap-1">
                     {!product.inStock && <span className="bg-gray-500/90 text-white text-[10px] font-bold px-2 py-1 rounded uppercase backdrop-blur-sm">Out of Stock</span>}
                     {product.inStock && <span className="bg-primary/90 text-white text-[10px] font-bold px-2 py-1 rounded uppercase backdrop-blur-sm">In Stock</span>}
                  </div>
                  {product.salePercent > 0 && (
                     <div className="absolute top-3 right-3 bg-red-600 text-white text-[10px] font-bold px-2 py-1 rounded shadow-sm">
                       {product.salePercent}% OFF
                     </div>
                  )}
                </div>
                <div className="p-4">
                  <h3 className="font-serif font-bold text-gray-800 text-lg mb-1 truncate">{product.name}</h3>
                  <div className="flex items-center gap-2">
                    {product.salePercent > 0 && <span className="text-gray-400 line-through text-sm">₱{product.originalPrice}</span>}
                    <span className={`font-bold text-lg ${product.salePercent > 0 ? 'text-red-600' : 'text-primary'}`}>₱{product.price}</span>
                  </div>
                </div>
              </div>
            ))}
          </div>
        )}
      </div>
    </div>
  );

  const renderDetail = () => {
    if (!detailProduct) return null;
    return (
      <div className="container mx-auto px-4 py-8 animate-fade-in">
        <button onClick={() => setView('home')} className="mb-6 flex items-center text-gray-500 hover:text-primary transition-colors">
          <i className="fas fa-arrow-left mr-2"></i> Back to Shop
        </button>

        <div className="bg-white rounded-3xl shadow-lg p-6 md:p-10 border border-gray-50">
          <div className="flex flex-col md:flex-row gap-10">
            {/* Image */}
            <div className="w-full md:w-1/2">
               <div className="rounded-2xl overflow-hidden shadow-inner bg-gray-100 relative pt-[133%]">
                 <img src={detailProduct.image} className="absolute top-0 left-0 w-full h-full object-cover" alt={detailProduct.name} />
               </div>
            </div>

            {/* Info */}
            <div className="w-full md:w-1/2 flex flex-col">
              <span className="text-sm text-gold font-bold uppercase tracking-wider mb-2">{detailProduct.category}</span>
              <h1 className="font-serif text-4xl md:text-5xl font-bold text-primary mb-4">{detailProduct.name}</h1>
              
              <div className="flex items-center gap-4 mb-6">
                 {detailProduct.salePercent > 0 && (
                   <span className="text-xl text-gray-400 line-through">₱{detailProduct.originalPrice}</span>
                 )}
                 <span className={`text-3xl font-bold ${detailProduct.salePercent > 0 ? 'text-red-600' : 'text-primary'}`}>
                   ₱{detailProduct.price}
                 </span>
                 {detailProduct.salePercent > 0 && <span className="bg-red-100 text-red-600 text-xs font-bold px-2 py-1 rounded">SALE</span>}
              </div>

              <p className="text-gray-600 leading-relaxed mb-8 border-b border-gray-100 pb-8">
                {detailProduct.desc}
              </p>

              {/* Controls */}
              <div className="space-y-6">
                <div>
                  <label className="block text-xs font-bold uppercase text-gray-500 mb-2">Size</label>
                  <div className="flex gap-3">
                    {SIZES.map(s => (
                      <button 
                        key={s} 
                        onClick={() => setDetailSize(s)}
                        className={`w-12 h-12 rounded-full flex items-center justify-center font-bold transition-all ${detailSize === s ? 'bg-primary text-white shadow-lg scale-110' : 'bg-white border border-gray-200 text-gray-600 hover:border-primary'}`}
                      >
                        {s}
                      </button>
                    ))}
                  </div>
                </div>

                <div>
                  <label className="block text-xs font-bold uppercase text-gray-500 mb-2">Height</label>
                  <input 
                    type="text" 
                    value={detailHeight}
                    onChange={(e) => setDetailHeight(e.target.value)}
                    placeholder="e.g., 5'4"
                    className="w-full md:w-1/2 px-4 py-3 rounded-lg border border-gray-200 focus:outline-none focus:border-primary focus:ring-1 focus:ring-primary"
                  />
                </div>

                <div>
                  <label className="block text-xs font-bold uppercase text-gray-500 mb-2">Quantity</label>
                  <div className="flex items-center bg-gray-50 rounded-lg w-fit border border-gray-200">
                    <button onClick={() => setDetailQty(Math.max(1, detailQty - 1))} className="w-10 h-10 flex items-center justify-center text-gray-600 hover:text-primary"><i className="fas fa-minus"></i></button>
                    <span className="w-10 text-center font-bold text-primary">{detailQty}</span>
                    <button onClick={() => setDetailQty(detailQty + 1)} className="w-10 h-10 flex items-center justify-center text-gray-600 hover:text-primary"><i className="fas fa-plus"></i></button>
                  </div>
                </div>

                <button 
                  onClick={addToCart}
                  disabled={!detailProduct.inStock}
                  className={`w-full py-4 rounded-full font-bold uppercase tracking-wider shadow-lg transition-transform active:scale-95 ${detailProduct.inStock ? 'bg-primary text-white hover:bg-primary-light hover:shadow-xl' : 'bg-gray-300 text-gray-500 cursor-not-allowed'}`}
                >
                  {detailProduct.inStock ? 'Add to Cart' : 'Out of Stock'}
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    );
  };

  const renderCart = () => {
    const total = cart.reduce((acc, item) => acc + (item.price * item.qty), 0);
    
    return (
      <div className="container mx-auto px-4 py-12 animate-fade-in max-w-4xl">
        <h2 className="font-serif text-3xl font-bold text-center mb-8">Shopping Cart</h2>
        
        {cart.length === 0 ? (
          <div className="text-center py-20 bg-white rounded-2xl shadow-sm">
            <i className="fas fa-shopping-basket text-6xl text-gray-200 mb-4"></i>
            <p className="text-gray-500">Your cart is empty.</p>
            <button onClick={() => setView('home')} className="mt-4 text-primary font-bold hover:underline">Start Shopping</button>
          </div>
        ) : (
          <>
            <div className="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden mb-8">
              {cart.map((item, idx) => (
                <div key={idx} className="flex items-center p-4 border-b border-gray-100 last:border-0 hover:bg-gray-50 transition-colors">
                   <div className="w-20 h-20 rounded-lg overflow-hidden flex-shrink-0 bg-gray-100">
                     <img src={item.image} className="w-full h-full object-cover" alt={item.name} />
                   </div>
                   <div className="ml-4 flex-grow">
                      <h4 className="font-bold text-gray-800">{item.name}</h4>
                      <p className="text-xs text-gray-500">Size: {item.size} | Height: {item.height}</p>
                      <div className="text-primary font-bold mt-1">₱{item.price}</div>
                   </div>
                   
                   <div className="flex flex-col items-end gap-2">
                      <div className="flex items-center bg-white rounded-md border border-gray-200 shadow-sm h-8">
                        <button onClick={() => updateCartQty(idx, -1)} className="px-2 h-full text-gray-500 hover:text-red-500"><i className="fas fa-minus text-xs"></i></button>
                        <span className="px-2 text-sm font-bold w-8 text-center">{item.qty}</span>
                        <button onClick={() => updateCartQty(idx, 1)} className="px-2 h-full text-gray-500 hover:text-green-600"><i className="fas fa-plus text-xs"></i></button>
                      </div>
                      <div className="text-sm font-bold text-gray-800">₱{item.price * item.qty}</div>
                   </div>
                </div>
              ))}
            </div>

            <div className="bg-white rounded-2xl shadow-lg p-6 flex flex-col md:flex-row justify-between items-center border border-gray-100">
               <div className="mb-4 md:mb-0 text-center md:text-left">
                  <span className="text-gray-500 block text-sm">Total Amount</span>
                  <span className="text-3xl font-serif font-bold text-primary">₱{total.toLocaleString()}</span>
               </div>
               <button onClick={() => setView('checkout')} className="bg-primary text-white px-10 py-3 rounded-full font-bold uppercase tracking-wider hover:bg-primary-light shadow-md transition-all">
                 Proceed to Checkout
               </button>
            </div>
          </>
        )}
      </div>
    );
  };

  // --- CHECKOUT LOGIC ---
  const CheckoutView: React.FC<{ cart: CartItem[], onBack: () => void, clearCart: () => void }> = ({ cart, onBack, clearCart }) => {
     const [formData, setFormData] = useState<CustomerDetails>({
       name: '', phone: '', email: '',
       address: { street: '', brgy: '', city: '', prov: '', region: '', zip: '' }
     });
     const [deliveryMethod, setDeliveryMethod] = useState('');
     const [donationPercent, setDonationPercent] = useState(0);
     const [donationNote, setDonationNote] = useState('');
     const [proofFile, setProofFile] = useState<File | null>(null);
     const [refNo, setRefNo] = useState('');
     const [isSubmitting, setIsSubmitting] = useState(false);

     const subtotal = cart.reduce((a, c) => a + (c.price * c.qty), 0);
     const itemCount = cart.reduce((a, c) => a + c.qty, 0);

     const shippingFee = useMemo(() => {
        if (deliveryMethod !== 'Delivery' || !formData.address.region) return 0;
        const r = formData.address.region;
        const c = itemCount;
        if (r === 'Metro Manila') return c === 1 ? 90 : c <= 3 ? 140 : 250;
        if (r === 'Luzon') return c === 1 ? 100 : c <= 3 ? 170 : 320;
        if (r === 'Visayas') return c === 1 ? 140 : c <= 3 ? 210 : 370;
        if (r === 'Mindanao') return c === 1 ? 145 : c <= 3 ? 220 : 380;
        return c === 1 ? 150 : c <= 3 ? 250 : 400; // Island
     }, [deliveryMethod, formData.address.region, itemCount]);

     const donationAmount = Math.ceil(subtotal * donationPercent);
     const grandTotal = subtotal + shippingFee + donationAmount;

     const handleInputChange = (field: keyof CustomerDetails | string, value: string) => {
        if (field.includes('.')) {
           const [parent, child] = field.split('.');
           // @ts-ignore
           setFormData({ ...formData, [parent]: { ...formData[parent], [child]: value } });
        } else {
           // @ts-ignore
           setFormData({ ...formData, [field]: value });
        }
     };

     const handleSubmit = async (e: React.FormEvent) => {
        e.preventDefault();
        if (!proofFile) { Swal.fire('Error', 'Please upload proof of payment', 'error'); return; }
        
        setIsSubmitting(true);
        const reader = new FileReader();
        reader.readAsDataURL(proofFile);
        reader.onload = async () => {
           const base64 = reader.result as string;
           const orderPayload: OrderData = {
              action: 'placeOrder',
              cust: {
                 name: formData.name,
                 phone: formData.phone,
                 email: formData.email,
                 addr: `${formData.address.street}, ${formData.address.brgy}, ${formData.address.city}, ${formData.address.prov}, ${formData.address.region}, ${formData.address.zip}`
              },
              pay: { ref: refNo, image: base64, mime: proofFile.type },
              cart: cart,
              total: `₱${grandTotal.toLocaleString()}`,
              donation: { percent: `${donationPercent * 100}%`, amount: donationAmount, note: donationNote },
              delivery: { method: deliveryMethod, region: formData.address.region || 'N/A', fee: shippingFee }
           };
           
           const res = await api.placeOrder(orderPayload);
           setIsSubmitting(false);
           
           if (res.status === 'success') {
              clearCart();
              Swal.fire({ 
                 title: 'Order Successful!', 
                 html: `Your Order ID: <b>${res.orderId}</b><br>Please save this ID for tracking.`, 
                 icon: 'success', confirmButtonColor: '#1b4d3e' 
              }).then(() => setView('home'));
           } else {
              Swal.fire('Error', res.error || 'Failed to place order', 'error');
           }
        };
     };

     return (
        <div className="container mx-auto px-4 py-8 max-w-3xl animate-fade-in">
           <button onClick={onBack} className="text-gray-500 mb-4"><i className="fas fa-arrow-left"></i> Back to Cart</button>
           <h2 className="font-serif text-3xl font-bold mb-6 text-center">Checkout</h2>
           
           <form onSubmit={handleSubmit} className="bg-white p-6 md:p-8 rounded-3xl shadow-xl border border-gray-50">
              
              <div className="mb-8">
                 <h3 className="text-sm font-bold uppercase text-gray-400 tracking-wider mb-4 border-b pb-2">1. Delivery & Contact</h3>
                 <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div className="col-span-2">
                       <label className="text-xs font-bold text-primary">Delivery Method</label>
                       <select required className="w-full p-3 bg-gray-50 rounded-lg border border-gray-200" value={deliveryMethod} onChange={(e) => setDeliveryMethod(e.target.value)}>
                          <option value="">Select Method</option>
                          <option value="Pick-up">Pick-up (Free)</option>
                          <option value="Delivery">Delivery (Courier)</option>
                       </select>
                    </div>
                    <input required type="text" placeholder="Full Name" className="p-3 bg-gray-50 rounded-lg border border-gray-200" value={formData.name} onChange={e => handleInputChange('name', e.target.value)} />
                    <input required type="tel" placeholder="Phone Number" className="p-3 bg-gray-50 rounded-lg border border-gray-200" value={formData.phone} onChange={e => handleInputChange('phone', e.target.value)} />
                    <input required type="email" placeholder="Email Address" className="col-span-2 p-3 bg-gray-50 rounded-lg border border-gray-200" value={formData.email} onChange={e => handleInputChange('email', e.target.value)} />
                    
                    {/* Address Fields */}
                    <div className="col-span-2 mt-2"><label className="text-xs font-bold text-gray-400">Address Details</label></div>
                    <input required type="text" placeholder="House / Street / Subdivision" className="col-span-2 p-3 bg-gray-50 rounded-lg border border-gray-200" value={formData.address.street} onChange={e => handleInputChange('address.street', e.target.value)} />
                    <input required type="text" placeholder="Barangay" className="p-3 bg-gray-50 rounded-lg border border-gray-200" value={formData.address.brgy} onChange={e => handleInputChange('address.brgy', e.target.value)} />
                    <input required type="text" placeholder="City" className="p-3 bg-gray-50 rounded-lg border border-gray-200" value={formData.address.city} onChange={e => handleInputChange('address.city', e.target.value)} />
                    <input required type="text" placeholder="Province" className="p-3 bg-gray-50 rounded-lg border border-gray-200" value={formData.address.prov} onChange={e => handleInputChange('address.prov', e.target.value)} />
                    <select required className="p-3 bg-gray-50 rounded-lg border border-gray-200" value={formData.address.region} onChange={e => handleInputChange('address.region', e.target.value)}>
                       <option value="">Select Region</option>
                       {DELIVERY_REGIONS.map(r => <option key={r} value={r}>{r}</option>)}
                    </select>
                    <input required type="text" placeholder="Zip Code" className="p-3 bg-gray-50 rounded-lg border border-gray-200" value={formData.address.zip} onChange={e => handleInputChange('address.zip', e.target.value)} />
                 </div>
              </div>

              {/* Donation */}
              <div className="mb-8 p-4 bg-green-50 rounded-2xl border border-green-100">
                 <div className="bg-primary text-gold text-xs font-bold p-2 rounded mb-3 overflow-hidden whitespace-nowrap">
                   <div className="animate-marquee">✨ DONATE TO ORPHANS • SADQA JARIYAH • HELP THOSE IN NEED • AL-JAZAA PH CHARITY ✨</div>
                 </div>
                 <p className="text-sm text-gray-600 mb-3 text-center">Would you like to add a donation percentage?</p>
                 <div className="flex flex-wrap gap-2 justify-center mb-3">
                    {[0, 0.05, 0.10, 0.20, 0.50].map(p => (
                       <button key={p} type="button" onClick={() => setDonationPercent(p)} className={`px-4 py-2 rounded-full text-sm font-bold border transition-colors ${donationPercent === p ? 'bg-primary text-white border-primary' : 'bg-white text-primary border-primary hover:bg-green-100'}`}>
                          {p === 0 ? 'None' : `${p * 100}%`}
                       </button>
                    ))}
                 </div>
                 {donationPercent > 0 && <textarea placeholder="Special Note / Intention (Optional)" className="w-full p-2 text-sm rounded border border-gray-200" value={donationNote} onChange={e => setDonationNote(e.target.value)} rows={2}></textarea>}
              </div>

              {/* Summary */}
              <div className="mb-8 bg-gray-50 p-6 rounded-2xl">
                 <h3 className="text-sm font-bold uppercase text-gray-400 tracking-wider mb-4">2. Payment Summary</h3>
                 <div className="flex justify-between mb-2 text-sm"><span>Subtotal</span><span>₱{subtotal.toLocaleString()}</span></div>
                 <div className="flex justify-between mb-2 text-sm"><span>Delivery Fee</span><span className="text-red-500">₱{shippingFee}</span></div>
                 {donationPercent > 0 && <div className="flex justify-between mb-2 text-sm"><span>Donation</span><span className="text-green-600">₱{donationAmount}</span></div>}
                 <hr className="my-3 border-gray-200" />
                 <div className="flex justify-between text-xl font-bold text-primary"><span>Grand Total</span><span>₱{grandTotal.toLocaleString()}</span></div>
                 
                 <div className="mt-4 flex items-center bg-white p-3 rounded-xl border border-gray-200 shadow-sm">
                    <div className="bg-blue-500 text-white p-2 rounded mr-3"><i className="fas fa-qrcode fa-lg"></i></div>
                    <div>
                       <div className="font-bold text-sm">GCash: 0921-429-5887</div>
                       <div className="text-xs text-gray-500">Please send exact amount.</div>
                    </div>
                 </div>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                 <input required type="text" placeholder="GCash Reference No." className="p-3 bg-gray-50 rounded-lg border border-gray-200" value={refNo} onChange={e => setRefNo(e.target.value)} />
                 <div className="relative">
                   <input required type="file" accept="image/*" onChange={e => setProofFile(e.target.files ? e.target.files[0] : null)} className="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10" />
                   <div className="p-3 bg-gray-50 rounded-lg border border-gray-200 text-gray-400 flex items-center justify-between">
                      <span className="truncate text-sm">{proofFile ? proofFile.name : 'Upload Proof (Screenshot)'}</span>
                      <i className="fas fa-upload"></i>
                   </div>
                 </div>
              </div>

              <button type="submit" disabled={isSubmitting} className="w-full bg-primary text-white py-4 rounded-full font-bold uppercase tracking-widest shadow-lg hover:bg-primary-light transition-all disabled:opacity-50">
                 {isSubmitting ? 'Processing...' : 'Place Order'}
              </button>
           </form>
           <style>{`@keyframes marquee { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } } .animate-marquee { display: inline-block; white-space: nowrap; animation: marquee 15s linear infinite; }`}</style>
        </div>
     );
  };

  const renderTrack = () => {
    const [trackId, setTrackId] = useState('');
    const [result, setResult] = useState<any>(null);
    const [tLoading, setTLoading] = useState(false);

    const handleTrack = async () => {
      if(!trackId) return;
      setTLoading(true);
      const res = await api.trackOrder(trackId);
      setResult(res);
      setTLoading(false);
    };

    return (
      <div className="container mx-auto px-4 py-20 animate-fade-in max-w-md">
         <div className="text-center mb-10">
            <h2 className="font-serif text-3xl font-bold mb-2">Track Your Order</h2>
            <p className="text-gray-500">Enter your Order ID sent after checkout.</p>
         </div>
         
         <div className="flex shadow-lg rounded-full overflow-hidden mb-8 border border-gray-100">
            <input type="text" value={trackId} onChange={e => setTrackId(e.target.value)} placeholder="Order ID (e.g. #1234)" className="flex-1 pl-6 py-3 outline-none" />
            <button onClick={handleTrack} className="bg-primary text-white px-6 font-bold hover:bg-primary-light">Search</button>
         </div>

         {tLoading && <div className="text-center"><i className="fas fa-spinner fa-spin text-primary fa-2x"></i></div>}

         {result && (
           <div className={`p-6 rounded-2xl shadow-md border ${result.status === 'found' ? 'bg-white border-green-100' : 'bg-red-50 border-red-100'}`}>
              {result.status === 'found' ? (
                 <>
                   <div className="text-center mb-4">
                      <div className="text-sm text-gray-400 uppercase tracking-widest">Status</div>
                      <div className="text-2xl font-bold text-primary mt-1">{result.currStatus}</div>
                   </div>
                   <div className="flex justify-between text-sm border-t pt-4 text-gray-600">
                      <span>Date: {result.date}</span>
                      <span>Total: {result.total}</span>
                   </div>
                 </>
              ) : (
                <div className="text-center text-red-500 font-bold">Order not found. Please check ID.</div>
              )}
           </div>
         )}
      </div>
    );
  };

  return (
    <Layout 
      cartCount={cart.length} 
      onNavigate={setView}
      categories={categories}
      onSelectCategory={setSelectedCategory}
    >
      {view === 'home' && renderHome()}
      {view === 'detail' && renderDetail()}
      {view === 'cart' && renderCart()}
      {view === 'checkout' && <CheckoutView cart={cart} onBack={() => setView('cart')} clearCart={() => setCart([])} />}
      {view === 'track' && renderTrack()}
    </Layout>
  );
};

export default App;
