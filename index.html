<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Al-Jazaa Ph. | Online Shop</title>
    
    <!-- Favicon -->
    <link rel="icon" type="image/png" href="https://github.com/ianianguro-art/Website-Gallery-Image/blob/main/Jaz%20Logo%20gold.png?raw=true">

    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <!-- SweetAlert2 -->
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    
    <style>
        :root {
            --primary: #1b4d3e; 
            --primary-dark: #143a2f;
            --gold: #c5a028;
            --bg-color: #f4f6f8; 
            --text: #2c3e50;
            --nav-height: 65px;
        }

        body { 
            font-family: 'Outfit', sans-serif; 
            background-color: var(--bg-color); 
            color: var(--text); 
            padding-top: 35px; /* For Announcement Bar */
            padding-bottom: 0px;
        }
        
        h1, h2, h3, h4, h5, .navbar-brand { font-family: 'Playfair Display', serif; }

        /* 1. Flash Effect Announcement (Home Only) */
        .announcement-bar { 
            background: var(--primary); 
            color: white; 
            height: 35px;
            position: fixed; top: 0; left: 0; width: 100%; z-index: 2000;
            display: flex; align-items: center; justify-content: center;
            overflow: hidden;
        }
        .flash-text {
            animation: flash 2s infinite alternate;
            font-weight: 600; font-size: 0.8rem; letter-spacing: 1px; text-transform: uppercase;
        }
        @keyframes flash { from { opacity: 1; } to { opacity: 0.6; color: var(--gold); } }

        /* Navbar */
        .navbar { 
            background: rgba(255,255,255,0.95); backdrop-filter: blur(10px); 
            box-shadow: 0 4px 20px rgba(0,0,0,0.05); height: var(--nav-height);
            z-index: 1030; top: 35px;
        }
        .navbar-brand { font-weight: 700; color: var(--primary) !important; font-size: 1.3rem; }
        .nav-logo-img { height: 35px; width: auto; margin-right: 8px; }

        /* 2. Menu - 75% Width */
        .offcanvas { border-radius: 0 20px 20px 0; max-width: 80%; width: 300px; }
        .sidebar-link { padding: 15px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; text-decoration: none; color: #333; font-weight: 500; }
        .sidebar-link:hover { background: #f9f9f9; color: var(--primary); }

        /* 3. Modern Shop Now Button */
        .btn-hero { 
            background: rgba(255,255,255,0.2); backdrop-filter: blur(5px);
            color: white; border: 1px solid white; 
            padding: 8px 25px; font-size: 0.8rem; font-weight: 600; 
            text-transform: uppercase; letter-spacing: 2px; border-radius: 4px; 
            transition: 0.3s; 
        }
        .btn-hero:hover { background: white; color: var(--primary); transform: translateY(-3px); }

        /* 4. Search Bar on Top */
        .top-search-container {
            padding: 15px; background: white; margin-bottom: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.02);
        }
        .modern-search { border-radius: 50px; background: #f0f2f5; border: none; padding: 10px 20px; width: 100%; }

        /* Categories */
        .category-scroll-container { overflow-x: auto; white-space: nowrap; padding: 10px 0; scrollbar-width: none; }
        .category-scroll-container::-webkit-scrollbar { display: none; }
        .cat-card { display: inline-block; margin-right: 15px; text-align: center; width: 80px; cursor: pointer; }
        .cat-card img { width: 60px; height: 60px; border-radius: 50%; border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1); object-fit: contain; background: white; transition: 0.3s; }
        .cat-card.active img { border-color: var(--primary); transform: scale(1.1); }
        .cat-card span { font-size: 0.75rem; display: block; margin-top: 5px; font-weight: 600; color: #555; }

        /* Products */
        .product-card { border: none; border-radius: 12px; overflow: hidden; background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.03); transition: 0.3s; height: 100%; }
        .product-card:hover { transform: translateY(-5px); box-shadow: 0 10px 20px rgba(0,0,0,0.08); }
        .card-img-wrapper { position: relative; padding-top: 133%; background: #f8f9fa; }
        .card-img-wrapper img { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        
        /* 5. Detail View Overhaul */
        #detail-view { 
            position: fixed; inset: 0; background: white; z-index: 2050; 
            overflow-y: auto; display: none; padding-top: 0; 
            padding-bottom: 80px; /* Space for sticky footer */
        }
        
        /* Detail Header */
        .detail-header {
            position: sticky; top: 0; z-index: 2060; background: rgba(255,255,255,0.98);
            border-bottom: 1px solid #eee; padding: 10px 15px; display: flex; 
            align-items: center; justify-content: space-between; height: 60px;
        }

        /* Scrollable Images */
        .dt-scroll-images {
            display: flex; overflow-x: auto; scroll-snap-type: x mandatory; 
            gap: 10px; padding-bottom: 10px; -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
        }
        .dt-scroll-images::-webkit-scrollbar { display: none; }
        .dt-scroll-images img {
            scroll-snap-align: center; flex: 0 0 100%; width: 100%; 
            aspect-ratio: 3/4; object-fit: contain; background: #f9f9f9;
        }

        /* Bundle Cards */
        .bundle-option {
            border: 1px solid #ddd; border-radius: 8px; padding: 12px; 
            margin-bottom: 10px; cursor: pointer; transition: 0.2s;
            display: flex; justify-content: space-between; align-items: center;
        }
        .bundle-option.selected { border-color: var(--primary); background-color: #f0f7f4; box-shadow: 0 2px 5px rgba(27,77,62,0.1); }
        .bundle-badge { font-size: 0.7rem; background: var(--gold); color: white; padding: 2px 6px; border-radius: 4px; margin-left: 5px; }

        /* Sticky Action Bar (Detail) */
        .sticky-action-bar {
            position: fixed; bottom: 0; left: 0; width: 100%; 
            background: white; padding: 10px 20px; 
            box-shadow: 0 -4px 15px rgba(0,0,0,0.05); z-index: 2070;
            display: flex; align-items: center; justify-content: space-between;
        }

        /* Cart Progress Bar */
        .free-ship-bar { height: 6px; background: #eee; border-radius: 10px; overflow: hidden; margin: 10px 0; position: relative; }
        .free-ship-fill { height: 100%; background: linear-gradient(90deg, var(--gold), var(--primary)); width: 0%; transition: width 1s ease; }
        .ship-icon { position: absolute; top: -20px; font-size: 1.2rem; color: var(--primary); transition: left 1s ease; transform: translateX(-50%); }

        /* Checkout Summary */
        .checkout-summary-header {
            background: #f8f9fa; padding: 15px; border-radius: 8px; 
            cursor: pointer; display: flex; justify-content: space-between; 
            font-weight: 600; margin-bottom: 10px; border: 1px solid #eee;
        }

        /* Utils */
        .btn-custom { background: var(--primary); color: white; border: none; border-radius: 50px; padding: 12px 20px; font-weight: 600; text-transform: uppercase; width: 100%; transition: 0.3s; }
        .btn-custom:hover { background: var(--primary-dark); }
        
        .back-to-top {
            position: fixed; bottom: 100px; right: 20px;
            width: 45px; height: 45px; background: white; color: var(--primary);
            border-radius: 50%; box-shadow: 0 4px 10px rgba(0,0,0,0.15);
            display: flex; align-items: center; justify-content: center;
            opacity: 0; visibility: hidden; transition: 0.3s; z-index: 1040;
        }
        .back-to-top.visible { opacity: 1; visibility: visible; }

        /* Reviews */
        .review-section { background: #fff; padding: 20px; margin-top: 20px; border-top: 5px solid #f4f6f8; }
        .rating-stars i { color: #ddd; cursor: pointer; font-size: 1.2rem; }
        .rating-stars i.active { color: var(--gold); }

        footer { background: #143a2f; color: #ccc; padding: 40px 0; margin-top: auto; }
        .footer-visible { display: block !important; } /* Ensures visibility */
    </style>
</head>
<body>

<script>
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzQ3ij0tm5k-cARhUqdRdV7yYmqfudy0LJnaK70DVAMyTcjO-vcc5WvwFQ36lRxobcF/exec"; 
</script>

<div id="loader" style="position:fixed; inset:0; background:white; z-index:9999; display:flex; justify-content:center; align-items:center;">
    <div class="spinner-border text-secondary" style="width:3rem;height:3rem;"></div>
</div>

<!-- Flashing Announcement (Home Only handled via JS logic) -->
<div class="announcement-bar" id="top-bar">
    <div class="flash-text">
        ⚡ Free Delivery on orders over ₱3,000 ⚡ 5% of Profit Goes to Charity ⚡
    </div>
</div>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg sticky-top">
    <div class="container">
        <a class="navbar-brand" href="#" onclick="routeTo('home')">
            <img src="https://github.com/ianianguro-art/Website-Gallery-Image/blob/main/Jaz%20Logo%20gold.png?raw=true" alt="Logo" class="nav-logo-img">
            Al-Jazaa Ph.
        </a>
        <div class="d-flex align-items-center ms-auto">
             <div class="position-relative me-3" style="cursor:pointer" onclick="routeTo('cart')">
                <i class="fas fa-shopping-bag fa-lg" style="color:#333;"></i>
                <span id="cart-count" class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-warning text-dark" style="font-size:0.6rem;">0</span>
            </div>
            <button class="btn border-0 p-0" type="button" data-bs-toggle="offcanvas" data-bs-target="#sidebarMenu">
                <i class="fas fa-bars fa-lg text-dark"></i>
            </button>
        </div>
    </div>
</nav>

<!-- Sidebar -->
<div class="offcanvas offcanvas-start" tabindex="-1" id="sidebarMenu">
    <div class="offcanvas-header bg-success text-white">
        <h5 class="offcanvas-title font-playfair">Menu</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="offcanvas"></button>
    </div>
    <div class="offcanvas-body p-0">
        <a href="#" class="sidebar-link" onclick="routeTo('home'); closeSidebar();">Shop Home <i class="fas fa-chevron-right"></i></a>
        <a href="#" class="sidebar-link" onclick="routeTo('track'); closeSidebar();">Track Order <i class="fas fa-chevron-right"></i></a>
        <a href="#" class="sidebar-link" onclick="routeTo('cart'); closeSidebar();">View Cart <i class="fas fa-chevron-right"></i></a>
        
        <div class="p-3 bg-light mt-3">
            <small class="text-uppercase fw-bold text-muted">Categories</small>
            <div id="sidebar-categories" class="mt-2"></div>
        </div>
    </div>
</div>

<!-- HOME PAGE -->
<div id="page-home">
    <!-- Search on Top -->
    <div class="container mt-2">
        <div class="top-search-container rounded-pill">
            <div class="input-group">
                <span class="input-group-text bg-transparent border-0"><i class="fas fa-search text-muted"></i></span>
                <input type="text" id="searchBox" class="form-control border-0 bg-transparent shadow-none" placeholder="Search for items..." onkeyup="doSearch()">
            </div>
        </div>
    </div>

    <div id="heroCarousel" class="carousel slide mb-4" data-bs-ride="carousel">
        <div class="carousel-inner">
            <div class="carousel-item active">
                <img src="https://github.com/ianianguro-art/Menu-POS/blob/main/Header%201.png?raw=true" class="d-block w-100" alt="Slide 1">
                <div class="carousel-caption">
                    <button class="btn-hero" onclick="scrollToProducts()">Shop Now</button>
                </div>
            </div>
            <div class="carousel-item"><img src="https://github.com/ianianguro-art/Menu-POS/blob/main/Header%202.png?raw=true" class="d-block w-100" alt="Slide 2"></div>
            <div class="carousel-item"><img src="https://github.com/ianianguro-art/Menu-POS/blob/main/Header%203.png?raw=true" class="d-block w-100" alt="Slide 3"></div>
        </div>
    </div>

    <div class="container mb-5" id="shop-section">
        <h3 class="font-playfair mb-3">Categories</h3>
        <div id="category-list" class="category-scroll-container mb-4"></div>
        
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h3 class="font-playfair mb-0">Latest Collection</h3>
        </div>
        
        <div class="row row-cols-2 row-cols-md-3 row-cols-lg-4 g-3" id="product-grid"></div>
    </div>
</div>

<!-- DETAIL VIEW OVERLAY -->
<div id="detail-view">
    <!-- Sticky Detail Header -->
    <div class="detail-header">
        <div class="d-flex align-items-center">
            <button class="btn p-0 me-3" onclick="closeDetail()"><i class="fas fa-arrow-left fa-lg"></i></button>
            <span class="font-playfair fw-bold text-success" id="dt-header-title">Product</span>
        </div>
        <div class="position-relative" onclick="routeTo('cart'); closeDetail();">
            <i class="fas fa-shopping-bag fa-lg"></i>
            <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-warning text-dark" style="font-size:0.5rem;" id="dt-cart-count">0</span>
        </div>
    </div>

    <div class="container pb-5">
        <!-- Scrollable Images -->
        <div id="dt-scroll-images" class="dt-scroll-images mt-2"></div>
        <div class="text-center text-muted small mb-3"><i class="fas fa-ellipsis-h"></i> Swipe for more</div>

        <!-- Info -->
        <span class="badge bg-light text-dark border mb-2" id="dt-cat"></span>
        <h2 id="dt-name" class="font-playfair fw-bold mb-2"></h2>
        <div class="mb-3">
            <span id="dt-price" class="fs-2 fw-bold text-success"></span>
            <span id="dt-old-price" class="text-muted text-decoration-line-through ms-2"></span>
        </div>

        <p id="dt-desc" class="text-muted small"></p>
        
        <div class="mb-3">
            <label class="fw-bold small">SIZE</label>
            <div id="size-area" class="d-flex flex-wrap gap-2 mt-1"></div>
        </div>
        <div class="mb-3">
            <label class="fw-bold small">COLOR</label>
            <div id="color-area" class="d-flex flex-wrap gap-2 mt-1"></div>
        </div>
        <div class="mb-4">
            <label class="fw-bold small">HEIGHT (Required)</label>
            <input type="text" id="height-input" class="form-control" placeholder="e.g. 5'4">
        </div>

        <!-- Bundle Offers -->
        <div id="bundle-section" class="mb-4">
            <label class="fw-bold small mb-2 text-primary">BUNDLE & SAVE</label>
            <div class="bundle-option selected" onclick="selectBundle(1, this)">
                <span class="fw-bold">Buy 1 Piece</span>
                <span class="small text-muted">Standard Price</span>
            </div>
            <div class="bundle-option" onclick="selectBundle(2, this)">
                <span class="fw-bold">Buy 2 Pieces <span class="bundle-badge">5% OFF</span></span>
                <span class="fw-bold text-success" id="bundle-price-2"></span>
            </div>
            <div class="bundle-option" onclick="selectBundle(3, this)">
                <span class="fw-bold">Buy 3 Pieces <span class="bundle-badge">10% OFF</span></span>
                <span class="fw-bold text-success" id="bundle-price-3"></span>
            </div>
        </div>

        <!-- Reviews Section -->
        <div class="review-section rounded-3">
            <h5 class="font-playfair mb-3">Customer Reviews</h5>
            <div id="dt-reviews-list" class="mb-4"></div>
            
            <hr>
            <h6 class="fw-bold">Write a Review</h6>
            <form onsubmit="submitReview(event)">
                <div class="rating-stars mb-2" id="star-input">
                    <i class="fas fa-star" data-val="1" onclick="setRating(1)"></i>
                    <i class="fas fa-star" data-val="2" onclick="setRating(2)"></i>
                    <i class="fas fa-star" data-val="3" onclick="setRating(3)"></i>
                    <i class="fas fa-star" data-val="4" onclick="setRating(4)"></i>
                    <i class="fas fa-star" data-val="5" onclick="setRating(5)"></i>
                </div>
                <input type="hidden" id="r-rating-val" value="5">
                <input type="text" id="r-name" class="form-control mb-2 form-control-sm" placeholder="Your Name" required>
                <textarea id="r-msg" class="form-control mb-2 form-control-sm" rows="2" placeholder="Your Feedback" required></textarea>
                <!-- Photo upload placeholder (visual only for now) -->
                <div class="mb-2">
                    <label class="small text-muted"><i class="fas fa-camera"></i> Add Photo (Optional)</label>
                    <input type="file" class="form-control form-control-sm">
                </div>
                <button type="submit" class="btn btn-dark btn-sm w-100">Submit Review</button>
            </form>
        </div>
    </div>

    <!-- Sticky Bottom Bar -->
    <div class="sticky-action-bar">
        <div>
            <small class="text-muted d-block">Total</small>
            <span class="fw-bold text-success fs-5" id="sticky-total">₱0</span>
        </div>
        <div class="d-flex align-items-center gap-2">
            <div class="border rounded-pill px-2 d-flex align-items-center" style="height:40px;">
                <button class="btn btn-sm px-1 fw-bold" onclick="dtQty(-1)">-</button>
                <span id="dt-qty-display" class="mx-2 fw-bold">1</span>
                <button class="btn btn-sm px-1 fw-bold" onclick="dtQty(1)">+</button>
            </div>
            <button class="btn btn-custom py-2 px-4 shadow" onclick="addToCart()">ADD</button>
        </div>
    </div>
</div>

<!-- CART PAGE -->
<div id="page-cart" class="container my-5 d-none">
    <h2 class="text-center font-playfair mb-4">Your Shopping Bag</h2>
    
    <!-- Progress Bar -->
    <div class="card p-3 border-0 shadow-sm rounded-4 mb-4">
        <div class="d-flex justify-content-between small fw-bold">
            <span>₱0</span>
            <span class="text-success">Free Delivery @ ₱3,000</span>
        </div>
        <div class="free-ship-bar">
            <div class="ship-icon"><i class="fas fa-shipping-fast"></i></div>
            <div class="free-ship-fill" id="cart-progress-fill"></div>
        </div>
        <p class="text-center small text-muted mb-0" id="cart-progress-text">Add more items for free shipping!</p>
    </div>

    <div class="row justify-content-center">
        <div class="col-lg-8">
            <div id="cart-list"></div>
            
            <div class="mt-5">
                <h5 class="font-playfair">People also buy this item</h5>
                <div id="cart-upsell" class="d-flex gap-3" style="overflow-x:auto; padding-bottom:10px;"></div>
            </div>

            <div class="bg-white p-4 rounded-4 shadow-sm border mt-4">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <small class="text-muted d-block">Total Amount</small>
                        <div class="fs-4 fw-bold text-success" id="cart-total">₱0.00</div>
                    </div>
                    <button class="btn btn-custom px-5" style="width:auto;" onclick="routeTo('checkout')">CHECKOUT</button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- CHECKOUT PAGE -->
<div id="page-checkout" class="container my-5 d-none" style="max-width: 800px;">
    <h3 class="text-center mb-4 font-playfair">Checkout</h3>
    
    <form id="checkout-form" onsubmit="submitOrder(event)">
        
        <!-- Collapsible Order Summary (Top) -->
        <div class="checkout-summary-header" data-bs-toggle="collapse" data-bs-target="#orderSummaryBody">
            <span><i class="fas fa-shopping-cart me-2"></i> Show Order Summary</span>
            <i class="fas fa-chevron-down"></i>
        </div>
        <div class="collapse show mb-4" id="orderSummaryBody">
            <div class="card card-body bg-light border-0" id="checkout-order-list"></div>
            <div class="d-flex justify-content-between px-3 mt-2 fw-bold">
                <span>Total to Pay:</span>
                <span id="pay-total-header" class="text-primary">₱0</span>
            </div>
        </div>

        <div class="card p-4 shadow-sm border-0 rounded-4 mb-3">
            <h6 class="fw-bold mb-3">Delivery Information</h6>
            <div class="row g-3">
                <div class="col-12"><select class="form-select py-3" id="del-method" onchange="toggleDeliveryOptions()" required><option value="" disabled selected>Select Delivery Method</option><option value="Pick-up">Pick-up (Free)</option><option value="Delivery">Delivery (Courier)</option></select></div>
                <div class="col-md-6"><input type="text" class="form-control" id="c-name" placeholder="Full Name" required></div>
                <div class="col-md-6"><input type="number" class="form-control" id="c-phone" placeholder="Phone Number" required></div>
                <div class="col-12 delivery-fields" style="display:none;"><input type="text" class="form-control" id="addr-full" placeholder="Full Address (Street, Brgy, City, Province)"></div>
                <div class="col-12 delivery-fields" style="display:none;">
                    <select class="form-select" id="addr-region" onchange="calcShipping()">
                        <option value="" disabled selected>Select Region</option>
                        <option value="Metro Manila">Metro Manila</option>
                        <option value="Luzon">Luzon</option>
                        <option value="VisMin">Visayas / Mindanao</option>
                    </select>
                </div>
            </div>
        </div>

        <div class="card p-4 shadow-sm border-0 rounded-4 mb-3">
            <h6 class="fw-bold mb-3">Payment (GCash)</h6>
            <div class="alert alert-info text-center">
                Send to <strong>0976-551-3716</strong>
            </div>
            <input type="text" class="form-control mb-3" id="c-ref" placeholder="GCash Reference No." required>
            <input type="file" class="form-control" id="c-proof" accept="image/*" required>
        </div>

        <button type="submit" class="btn btn-custom py-3">PLACE ORDER</button>
    </form>
</div>

<!-- TRACKING -->
<div id="page-track" class="container my-5 d-none text-center" style="max-width:500px;">
    <h3 class="mb-3 font-playfair">Track Order</h3>
    <div class="input-group mb-4 shadow-sm rounded-pill overflow-hidden">
        <input type="text" id="track-id" class="form-control border-0 ps-4" placeholder="Order ID">
        <button class="btn btn-custom px-4" style="width:auto; border-radius:0;" onclick="trackOrder()">Search</button>
    </div>
    <div id="track-result" class="d-none card p-3"></div>
</div>

<!-- FOOTER (Always Visible) -->
<footer>
    <div class="container text-center">
        <h3 class="font-playfair text-white">Al-Jazaa Ph.</h3>
        <p class="small opacity-50">Timeless modesty with Islamic integrity.</p>
        <div class="mt-4">
            <a href="#" class="text-white text-decoration-none mx-2 small" onclick="routeTo('home')">Home</a>
            <a href="#" class="text-white text-decoration-none mx-2 small" onclick="routeTo('track')">Track</a>
            <a href="#" class="text-white text-decoration-none mx-2 small" onclick="routeTo('cart')">Cart</a>
        </div>
        <hr class="border-secondary opacity-25 mt-4">
        <p class="small opacity-25 mb-0">&copy; 2024 Al-Jazaa Ph.</p>
    </div>
</footer>

<!-- BACK TO TOP -->
<div class="back-to-top" onclick="window.scrollTo({top:0, behavior:'smooth'})"><i class="fas fa-arrow-up"></i></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
    let allProducts=[], cart=JSON.parse(localStorage.getItem('alj_cart_v15'))||[], curProduct={}, selectedSize=null, selectedColor=null;
    let selectedBundleQty = 1;
    let cartTotalAmount=0, currentShippingFee=0;
    
    // Category Images
    const catImages = {
        'All': 'https://cdn-icons-png.flaticon.com/512/3502/3502601.png', 
        'Niqab': 'https://github.com/ianianguro-art/Menu-POS/blob/main/cat1.png?raw=true',
        'Jilbab': 'https://github.com/ianianguro-art/Menu-POS/blob/main/cat2.png?raw=true',
        'Abaya': 'https://github.com/ianianguro-art/Menu-POS/blob/main/cat3.png?raw=true', 
        'Khimar': 'https://github.com/ianianguro-art/Menu-POS/blob/main/cat4.png?raw=true',
        'Default': 'https://cdn-icons-png.flaticon.com/512/4430/4430945.png'
    };

    document.addEventListener("DOMContentLoaded", () => {
        fetchProducts(); updateCartCount();
        window.onscroll = () => {
            const btn = document.querySelector('.back-to-top');
            if(window.scrollY > 300) btn.classList.add('visible'); else btn.classList.remove('visible');
        };
    });

    const closeSidebar = () => bootstrap.Offcanvas.getInstance(document.getElementById('sidebarMenu')).hide();
    const closeDetail = () => { document.getElementById('detail-view').style.display='none'; document.body.style.overflow = 'auto'; };

    function routeTo(pageId) { 
        document.querySelectorAll('[id^="page-"]').forEach(d=>d.classList.add('d-none'));
        document.getElementById('detail-view').style.display='none';
        document.getElementById('page-'+pageId).classList.remove('d-none');
        window.scrollTo(0,0);
        
        // Hide/Show Flash Bar
        document.getElementById('top-bar').style.display = (pageId === 'home') ? 'flex' : 'none';
        
        if(pageId==='cart') renderCart();
        if(pageId==='checkout') initCheckout();
    }

    function fetchProducts() {
        fetch(WEB_APP_URL + "?action=getProducts").then(r=>r.json()).then(data => { 
            allProducts = data; 
            document.getElementById('loader').style.display = 'none'; 
            renderCats(); renderProds(allProducts); 
        });
    }

    function renderCats() {
        const cats = ['All', ...new Set(allProducts.map(p => p.category))]; 
        document.getElementById('category-list').innerHTML = cats.map(c => `
            <div class="cat-card ${c==='All'?'active':''}" onclick="filterCat('${c}', this)">
                <img src="${catImages[c]||catImages['Default']}">
                <span>${c}</span>
            </div>
        `).join('');
        document.getElementById('sidebar-categories').innerHTML = cats.map(c => `<div class="p-2 border-bottom" onclick="filterCat('${c}',null,true)">${c}</div>`).join('');
    }

    function filterCat(c, el, sidebar=false) {
        if(el) { document.querySelectorAll('.cat-card').forEach(x=>x.classList.remove('active')); el.classList.add('active'); }
        renderProds(c==='All'?allProducts:allProducts.filter(p=>p.category===c));
        if(sidebar) { closeSidebar(); routeTo('home'); document.getElementById('shop-section').scrollIntoView({behavior:'smooth'}); }
    }

    function renderProds(list) {
        document.getElementById('product-grid').innerHTML = list.map(p => `
            <div class="col">
                <div class="product-card" onclick="openDetail('${p.id}')">
                    <div class="card-img-wrapper"><img src="${p.image}"></div>
                    <div class="p-3">
                        <div class="text-muted small text-uppercase">${p.category}</div>
                        <h6 class="fw-bold text-dark text-truncate">${p.name}</h6>
                        <div class="fw-bold text-success">₱${p.price}</div>
                    </div>
                </div>
            </div>
        `).join('');
    }

    function openDetail(id) {
        curProduct = allProducts.find(p=>p.id==id);
        selectedSize = null; selectedColor = null; selectedBundleQty = 1;
        document.getElementById('height-input').value = "";
        document.getElementById('dt-qty-display').innerText = "1";
        
        // Populate Data
        document.getElementById('dt-header-title').innerText = curProduct.name;
        document.getElementById('dt-name').innerText = curProduct.name;
        document.getElementById('dt-cat').innerText = curProduct.category;
        document.getElementById('dt-price').innerText = "₱" + curProduct.price;
        document.getElementById('dt-desc').innerText = curProduct.desc;
        document.getElementById('dt-cart-count').innerText = cart.length;

        // Scrollable Images
        const imgs = (curProduct.images && curProduct.images.length) ? curProduct.images : [curProduct.image];
        document.getElementById('dt-scroll-images').innerHTML = imgs.map(src => `<img src="${src}">`).join('');

        // Options
        const isNiqab = curProduct.category.toLowerCase() === 'niqab';
        document.getElementById('size-area').innerHTML = isNiqab ? '<span class="badge bg-secondary">One Size</span>' : 
            ["S","M","L","XL"].map(s => `<button class="btn btn-outline-dark btn-sm rounded-pill" onclick="pickOpt('size','${s}',this)">${s}</button>`).join('');
        
        const colors = curProduct.colors ? curProduct.colors.split(',') : ["Default"];
        document.getElementById('color-area').innerHTML = colors.map(c => `<button class="btn btn-outline-dark btn-sm rounded-pill" onclick="pickOpt('color','${c.trim()}',this)">${c.trim()}</button>`).join('');
        
        if(isNiqab) { selectedSize = "One Size"; document.getElementById('bundle-section').style.display='none'; }
        else { document.getElementById('bundle-section').style.display='block'; updateBundlePrices(); }

        // Mock Reviews
        document.getElementById('dt-reviews-list').innerHTML = `
            <div class="card p-3 border-0 bg-light mb-2"><div class="d-flex justify-content-between"><span class="fw-bold small">Amina K.</span><span class="text-warning small"><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i><i class="fas fa-star"></i></span></div><p class="small mb-0 text-muted">Beautiful quality!</p></div>
        `;

        updateStickyTotal();
        document.getElementById('detail-view').style.display='block';
        document.body.style.overflow = 'hidden'; // Stop background scroll
    }

    function pickOpt(type, val, el) {
        if(type==='size') selectedSize = val; else selectedColor = val;
        Array.from(el.parentNode.children).forEach(c=>c.classList.remove('active', 'btn-dark', 'text-white'));
        el.classList.add('active', 'btn-dark', 'text-white');
    }

    function dtQty(c) {
        // Only visual in this setup, usually would update logic. But we use Bundle logic for qty > 1
        // If bundles are active, disable manual qty or sync it.
        // For simplicity: If non-niqab, use bundle buttons. If niqab, use manual.
        let q = parseInt(document.getElementById('dt-qty-display').innerText) + c;
        if(q<1) q=1;
        document.getElementById('dt-qty-display').innerText = q;
        // if Niqab
        if(curProduct.category.toLowerCase() === 'niqab') {
            selectedBundleQty = q;
            updateStickyTotal();
        }
    }

    function selectBundle(qty, el) {
        selectedBundleQty = qty;
        document.querySelectorAll('.bundle-option').forEach(b=>b.classList.remove('selected'));
        el.classList.add('selected');
        document.getElementById('dt-qty-display').innerText = qty;
        updateStickyTotal();
    }

    function updateBundlePrices() {
        // Reset
        selectBundle(1, document.querySelector('.bundle-option'));
        let p = curProduct.price;
        document.getElementById('bundle-price-2').innerText = "₱" + Math.floor((p*2)*0.95);
        document.getElementById('bundle-price-3').innerText = "₱" + Math.floor((p*3)*0.90);
    }

    function updateStickyTotal() {
        let price = curProduct.price * selectedBundleQty;
        if(curProduct.category.toLowerCase() !== 'niqab') {
            if(selectedBundleQty === 2) price = price * 0.95;
            if(selectedBundleQty === 3) price = price * 0.90;
        }
        document.getElementById('sticky-total').innerText = "₱" + Math.floor(price);
    }

    function addToCart() {
        if(!selectedSize && curProduct.category !== 'Niqab') return Swal.fire('Error','Select Size','warning');
        if(!selectedColor) return Swal.fire('Error','Select Color','warning');
        let h = document.getElementById('height-input').value;
        if(!h) return Swal.fire('Error','Enter Height','warning');

        let finalPrice = curProduct.price;
        if(curProduct.category !== 'Niqab') {
             if(selectedBundleQty === 2) finalPrice = (curProduct.price * 2 * 0.95) / 2;
             if(selectedBundleQty === 3) finalPrice = (curProduct.price * 3 * 0.90) / 3;
        }

        cart.push({
            ...curProduct,
            price: Math.floor(finalPrice),
            qty: selectedBundleQty,
            size: selectedSize,
            color: selectedColor,
            height: h
        });
        localStorage.setItem('alj_cart_v15', JSON.stringify(cart));
        updateCartCount();
        Swal.fire({icon:'success', title:'Added', toast:true, position:'top-end', showConfirmButton:false, timer:1000});
        closeDetail();
    }

    function updateCartCount() { 
        document.getElementById('cart-count').innerText = cart.length; 
    }

    function renderCart() {
        const c = document.getElementById('cart-list');
        if(!cart.length) { 
            c.innerHTML = '<div class="text-center py-5 text-muted">Bag is empty</div>'; 
            updateCartCalc(0);
            return; 
        }
        let total = 0;
        c.innerHTML = cart.map((i,x) => {
            total += i.price * i.qty;
            return `
            <div class="card mb-3 border-0 shadow-sm">
                <div class="row g-0 align-items-center">
                    <div class="col-3"><img src="${i.image}" class="img-fluid rounded-start" style="height:100px; object-fit:cover;"></div>
                    <div class="col-7 p-2">
                        <div class="fw-bold text-truncate">${i.name}</div>
                        <div class="small text-muted">${i.size}, ${i.color}</div>
                        <div class="fw-bold text-success">₱${i.price} x ${i.qty}</div>
                    </div>
                    <div class="col-2 text-center"><i class="fas fa-trash text-danger" onclick="delItem(${x})"></i></div>
                </div>
            </div>`;
        }).join('');
        updateCartCalc(total);

        // Upsell Suggestions
        const upsell = allProducts.sort(()=>0.5-Math.random()).slice(0,5);
        document.getElementById('cart-upsell').innerHTML = upsell.map(p => `
            <div class="card border-0" style="min-width:120px;" onclick="openDetail('${p.id}')">
                <img src="${p.image}" class="rounded" style="height:120px; object-fit:cover;">
                <div class="small fw-bold text-truncate mt-1">${p.name}</div>
            </div>
        `).join('');
    }

    function updateCartCalc(total) {
        document.getElementById('cart-total').innerText = "₱" + total.toLocaleString();
        // Progress Bar
        let pct = (total / 3000) * 100;
        if(pct > 100) pct = 100;
        document.getElementById('cart-progress-fill').style.width = pct + "%";
        document.querySelector('.ship-icon').style.left = pct + "%";
        if(pct === 100) document.getElementById('cart-progress-text').innerHTML = "<span class='text-success fw-bold'>Free Delivery Unlocked!</span>";
        else document.getElementById('cart-progress-text').innerText = `Add ₱${(3000-total).toLocaleString()} for Free Delivery`;
    }

    function delItem(i) { cart.splice(i,1); localStorage.setItem('alj_cart_v15', JSON.stringify(cart)); updateCartCount(); renderCart(); }

    function initCheckout() {
        if(!cart.length) { routeTo('home'); return; }
        const list = document.getElementById('checkout-order-list');
        let total = 0;
        list.innerHTML = cart.map(i => {
            total += i.price * i.qty;
            return `<div class="d-flex justify-content-between small mb-1"><span>${i.qty}x ${i.name} (${i.size})</span><span>₱${i.price*i.qty}</span></div>`;
        }).join('');
        cartTotalAmount = total;
        calcShipping();
    }

    function toggleDeliveryOptions() {
        const v = document.getElementById('del-method').value;
        const els = document.querySelectorAll('.delivery-fields');
        els.forEach(e => e.style.display = (v === 'Delivery') ? 'block' : 'none');
        calcShipping();
    }

    function calcShipping() {
        currentShippingFee = 0;
        if(document.getElementById('del-method').value === 'Delivery') {
            // Simple logic: Free if > 3000, else based on region
            if(cartTotalAmount < 3000) {
                const r = document.getElementById('addr-region').value;
                if(r === 'Metro Manila') currentShippingFee = 100;
                else if(r === 'Luzon') currentShippingFee = 150;
                else if(r === 'VisMin') currentShippingFee = 200;
            }
        }
        document.getElementById('pay-total-header').innerText = "₱" + (cartTotalAmount + currentShippingFee).toLocaleString();
    }

    function submitOrder(e) {
        e.preventDefault();
        Swal.fire({title:'Processing', didOpen:()=>Swal.showLoading()});
        // Real logic would go here via fetch to Google Script
        setTimeout(() => {
            cart = []; localStorage.setItem('alj_cart_v15', '[]'); updateCartCount();
            Swal.fire('Success', 'Order Placed. Tracking ID: JAZ-12345', 'success').then(()=>routeTo('home'));
        }, 2000);
    }

    function doSearch() {
        const q = document.getElementById('searchBox').value.toLowerCase();
        renderProds(allProducts.filter(p=>p.name.toLowerCase().includes(q)));
        scrollToProducts();
    }
    
    function scrollToProducts() { document.getElementById('shop-section').scrollIntoView({behavior:'smooth'}); }
    
    // Star Rating UI
    function setRating(n) {
        document.getElementById('r-rating-val').value = n;
        document.querySelectorAll('#star-input i').forEach(el => {
            if(el.dataset.val <= n) { el.classList.remove('far'); el.classList.add('fas', 'text-warning'); }
            else { el.classList.remove('fas', 'text-warning'); el.classList.add('far'); }
        });
    }

    function submitReview(e) { e.preventDefault(); Swal.fire('Success', 'Review Submitted', 'success'); }
</script>
</body>
</html>
