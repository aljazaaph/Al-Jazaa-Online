<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Al-Jazaa | Premium Modest Wear</title>
    
    <!-- BRAND ASSETS -->
    <link rel="icon" type="image/png" href="https://github.com/ianianguro-art/Website-Gallery-Image/blob/main/Jaz%20Logo%20gold.png?raw=true">
    
    <!-- FONTS & ICONS -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- LIBRARIES -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: { 
                        primary: '#1b4d3e',     // Olive Green
                        secondary: '#c5a028',   // Gold
                        sand: '#f8f8f8',        // Light Background
                        dark: '#1a1a1a' 
                    },
                    fontFamily: { 
                        sans: ['Outfit', 'sans-serif'], 
                        serif: ['Playfair Display', 'serif'] 
                    }
                }
            }
        }
    </script>

    <style>
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        .loader-spin { border: 3px solid #f3f3f3; border-top: 3px solid #c5a028; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .glass-nav { background: rgba(255, 255, 255, 0.95); backdrop-filter: blur(10px); border-bottom: 1px solid rgba(0,0,0,0.05); }
        
        /* Receipt Generator Canvas (Hidden) */
        #receipt-render-area { font-family: 'Courier New', Courier, monospace; background: #fff; width: 380px; padding: 20px; color: #000; position: absolute; top: -9999px; left: -9999px; border: 1px solid #ddd; }
        .dashed-line { border-bottom: 1px dashed #000; margin: 10px 0; }
    </style>
</head>

<body class="bg-sand text-gray-800 antialiased pt-[80px]">

    <!-- PASTE YOUR NEW WEB APP URL HERE -->
    <script>const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbzQ3ij0tm5k-cARhUqdRdV7yYmqfudy0LJnaK70DVAMyTcjO-vcc5WvwFQ36lRxobcF/exec";</script>

    <!-- LOADING SCREEN -->
    <div id="loader" class="fixed inset-0 bg-white z-[9999] flex flex-col justify-center items-center">
        <div class="loader-spin mb-4"></div>
        <h3 class="font-serif text-2xl text-primary font-bold tracking-widest">AL-JAZAA</h3>
    </div>

    <!-- NAVBAR -->
    <nav class="fixed top-0 w-full z-50 glass-nav h-[80px] flex items-center shadow-sm">
        <div class="container mx-auto px-4 flex justify-between items-center">
            <!-- Logo -->
            <a href="#" onclick="routeTo('home')" class="flex items-center gap-2 group">
                <img src="https://github.com/ianianguro-art/Website-Gallery-Image/blob/main/Jaz%20Logo%20gold.png?raw=true" class="h-10 w-auto">
                <div class="flex flex-col">
                    <span class="font-serif text-xl md:text-2xl font-bold text-primary tracking-wide">AL-JAZAA</span>
                    <span class="text-[0.6rem] uppercase tracking-[0.2em] text-secondary hidden md:block">Halal & Modest</span>
                </div>
            </a>

            <!-- Desktop Menu -->
            <div class="hidden md:flex gap-8 text-xs font-bold uppercase tracking-widest text-gray-600">
                <a href="#" onclick="routeTo('home')" class="hover:text-primary transition">Home</a>
                <a href="#" onclick="routeTo('grid')" class="hover:text-primary transition">Shop All</a>
                <a href="#" onclick="openModal('track')" class="hover:text-primary transition">Track Order</a>
                <a href="#" onclick="openModal('reviews')" class="hover:text-primary transition">Reviews</a>
            </div>

            <!-- Icons -->
            <div class="flex items-center gap-6">
                <div class="relative cursor-pointer" onclick="routeTo('cart')">
                    <i class="fas fa-shopping-bag text-2xl text-primary hover:text-secondary transition"></i>
                    <span id="cart-count" class="absolute -top-1 -right-2 bg-secondary text-white text-[10px] font-bold h-4 w-4 flex items-center justify-center rounded-full">0</span>
                </div>
                <button onclick="document.getElementById('mobile-menu').classList.remove('translate-x-full')" class="md:hidden text-primary text-2xl"><i class="fas fa-bars"></i></button>
            </div>
        </div>
    </nav>

    <!-- MOBILE MENU -->
    <div id="mobile-menu" class="fixed inset-y-0 right-0 w-72 bg-white shadow-2xl transform translate-x-full transition-transform duration-300 z-[60] flex flex-col p-6">
        <div class="flex justify-between items-center mb-8">
            <h4 class="font-serif text-xl font-bold text-primary">Menu</h4>
            <button onclick="document.getElementById('mobile-menu').classList.add('translate-x-full')"><i class="fas fa-times text-xl"></i></button>
        </div>
        <div class="flex flex-col gap-6 font-bold text-gray-700">
            <a onclick="routeTo('home'); document.getElementById('mobile-menu').classList.add('translate-x-full')">Home</a>
            <a onclick="routeTo('grid'); document.getElementById('mobile-menu').classList.add('translate-x-full')">Shop All</a>
            <a onclick="openModal('track'); document.getElementById('mobile-menu').classList.add('translate-x-full')">Track Order</a>
            <a onclick="openModal('reviews'); document.getElementById('mobile-menu').classList.add('translate-x-full')">Reviews</a>
        </div>
        <div class="mt-auto border-t pt-6">
            <p class="text-xs text-center text-gray-400">© 2024 Al-Jazaa Ph.</p>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <main class="min-h-screen">

        <!-- 1. HOME PAGE -->
        <div id="page-home" class="view-section">
            <!-- Hero -->
            <div class="relative w-full h-[60vh] bg-cover bg-center flex items-center justify-center text-center px-4 mb-10" style="background-image: url('https://images.unsplash.com/photo-1596131460596-f9479b128503?q=80&w=2070&auto=format&fit=crop');">
                <div class="absolute inset-0 bg-black/40"></div>
                <div class="relative z-10 text-white">
                    <h1 class="font-serif text-5xl md:text-6xl font-bold mb-4">Modesty Elevated.</h1>
                    <p class="text-sm md:text-lg tracking-widest uppercase mb-8 opacity-90">Premium Islamic Wear for Men & Women</p>
                    <button onclick="routeTo('grid')" class="bg-white text-primary px-8 py-3 font-bold uppercase text-xs tracking-widest hover:bg-secondary hover:text-white transition">Shop Now</button>
                </div>
            </div>

            <div class="container mx-auto px-4 mb-12">
                <!-- Dynamic Categories -->
                <div class="flex justify-between items-end mb-6">
                    <h2 class="font-serif text-2xl font-bold text-primary">Browse Categories</h2>
                </div>
                <div id="home-cat-list" class="flex gap-4 overflow-x-auto hide-scrollbar pb-4"></div>

                <!-- New Arrivals -->
                <div class="flex justify-between items-end mb-6 mt-12">
                    <h2 class="font-serif text-2xl font-bold text-primary">New Arrivals</h2>
                    <button onclick="routeTo('grid')" class="text-xs font-bold text-secondary uppercase">View All</button>
                </div>
                <div id="home-products" class="flex gap-4 overflow-x-auto hide-scrollbar pb-6 snap-x"></div>

                <!-- Testimonials -->
                <div class="mt-16 bg-white p-8 rounded-xl shadow-sm border border-gray-100 text-center">
                    <h2 class="font-serif text-2xl font-bold text-primary mb-6">Customer Love</h2>
                    <div id="home-reviews" class="max-w-2xl mx-auto italic text-gray-600"></div>
                    <button onclick="openModal('reviews')" class="mt-6 text-xs font-bold text-secondary underline">Read More Reviews</button>
                </div>
            </div>
        </div>

        <!-- 2. PRODUCT GRID (ALL PRODUCTS) -->
        <div id="page-grid" class="view-section hidden container mx-auto px-4 py-8">
            <h2 id="grid-title" class="font-serif text-3xl font-bold text-primary mb-6 text-center">Shop Collection</h2>
            
            <!-- Category Filter Bar -->
            <div id="filter-bar" class="flex flex-wrap gap-2 justify-center mb-8"></div>

            <div class="relative max-w-md mx-auto mb-8">
                <input type="text" id="searchBox" placeholder="Search products..." class="w-full border p-3 pl-10 rounded-none focus:border-primary outline-none" oninput="doSearch()">
                <i class="fas fa-search absolute left-4 top-4 text-gray-400"></i>
            </div>

            <div id="product-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 md:gap-8"></div>
        </div>

        <!-- 3. PRODUCT DETAIL -->
        <div id="page-detail" class="view-section hidden bg-white min-h-screen pb-20">
            <div class="container mx-auto px-4 py-6">
                <button onclick="window.history.back()" class="text-xs uppercase tracking-widest text-gray-500 mb-6 flex items-center"><i class="fas fa-arrow-left mr-2"></i> Back</button>
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Image -->
                    <div>
                        <div class="aspect-[3/4] bg-gray-50 overflow-hidden relative mb-4">
                            <img id="dt-img" class="w-full h-full object-cover">
                            <span id="dt-badge" class="absolute top-4 left-4 bg-secondary text-white text-[10px] font-bold px-3 py-1 hidden">SALE</span>
                        </div>
                        <div id="dt-gallery" class="flex gap-2 overflow-x-auto hide-scrollbar"></div>
                    </div>

                    <!-- Info -->
                    <div>
                        <div id="dt-cat" class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-2"></div>
                        <h1 id="dt-name" class="font-serif text-3xl font-bold text-primary mb-2"></h1>
                        <div class="flex items-center gap-3 mb-6">
                            <span id="dt-price" class="text-2xl font-bold text-gray-800"></span>
                            <span id="dt-old-price" class="text-sm text-gray-400 line-through hidden"></span>
                        </div>
                        <p id="dt-desc" class="text-sm text-gray-600 leading-relaxed mb-8 border-b pb-6"></p>

                        <!-- Options -->
                        <div class="space-y-5 mb-8">
                            <div>
                                <label class="text-xs font-bold uppercase block mb-2">Size</label>
                                <div id="size-opts" class="flex flex-wrap gap-2"></div>
                            </div>
                            <div>
                                <label class="text-xs font-bold uppercase block mb-2">Color</label>
                                <div id="color-opts" class="flex flex-wrap gap-2"></div>
                            </div>
                            <div>
                                <label class="text-xs font-bold uppercase block mb-2">Height</label>
                                <input type="text" id="dt-height" class="w-full border p-2 text-sm outline-none focus:border-primary" placeholder="e.g. 5'6">
                            </div>
                        </div>

                        <!-- Bundle Logic -->
                        <div class="bg-gray-50 p-4 rounded mb-8">
                            <h4 class="text-xs font-bold uppercase text-primary mb-3">Bundle Offers</h4>
                            <div class="flex gap-2 text-sm">
                                <button onclick="setBundle(1, this)" class="bundle-btn flex-1 border bg-white py-2 active-bundle border-primary">1 Pc</button>
                                <button onclick="setBundle(2, this)" class="bundle-btn flex-1 border bg-white py-2">2 Pcs (5% Off)</button>
                                <button onclick="setBundle(3, this)" class="bundle-btn flex-1 border bg-white py-2">3 Pcs (10% Off)</button>
                            </div>
                        </div>

                        <!-- Add to Cart -->
                        <button id="btn-add" onclick="addToCart()" disabled class="w-full bg-primary disabled:bg-gray-300 text-white py-4 font-bold uppercase tracking-widest text-xs hover:bg-primary/90 transition">Add to Cart</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- 4. CART -->
        <div id="page-cart" class="view-section hidden container mx-auto px-4 py-8 max-w-2xl">
            <h1 class="font-serif text-2xl font-bold text-center mb-8">Shopping Bag</h1>
            <div id="cart-list" class="space-y-4 mb-8"></div>
            <div id="cart-summary" class="bg-white p-6 border shadow-sm hidden">
                <div class="flex justify-between text-xl font-bold mb-6">
                    <span>Total</span>
                    <span id="cart-total-display"></span>
                </div>
                <button onclick="routeTo('checkout')" class="w-full bg-secondary text-white py-3 font-bold uppercase text-xs tracking-widest hover:bg-yellow-600 transition">Checkout</button>
            </div>
        </div>

        <!-- 5. CHECKOUT (Original Function) -->
        <div id="page-checkout" class="view-section hidden container mx-auto px-4 py-8 max-w-xl pb-32">
            <div class="bg-white p-6 md:p-8 shadow-lg border border-gray-100">
                <h1 class="font-serif text-2xl font-bold text-primary text-center mb-2">Checkout</h1>
                <p class="text-center text-xs text-gray-500 mb-8">Complete your order details</p>

                <form id="checkout-form" onsubmit="submitOrder(event)">
                    <!-- Donation -->
                    <div class="bg-green-50 p-4 border border-green-100 rounded mb-6">
                        <h4 class="font-bold text-primary text-sm mb-2">Donate (Sadaqah)</h4>
                        <div class="flex gap-2 mb-2">
                            <button type="button" onclick="setDonation(0.05, this)" class="don-btn border border-primary text-primary px-3 py-1 text-xs bg-white">5%</button>
                            <button type="button" onclick="setDonation(0.10, this)" class="don-btn border border-primary text-primary px-3 py-1 text-xs bg-white">10%</button>
                            <button type="button" onclick="setDonation(0, this)" class="don-btn border border-primary text-white px-3 py-1 text-xs bg-primary">None</button>
                        </div>
                        <input id="don-note" type="text" placeholder="Intention / Note (Optional)" class="w-full text-xs p-2 border rounded hidden">
                    </div>

                    <!-- Delivery Info -->
                    <div class="space-y-4 mb-8">
                        <select id="del-method" onchange="toggleDelivery()" class="w-full p-3 border bg-gray-50 text-sm outline-none" required>
                            <option value="" disabled selected>Select Method</option>
                            <option value="Pick-up">Pick-up (Free)</option>
                            <option value="Delivery">Delivery (Courier)</option>
                        </select>
                        <input type="text" id="c-name" placeholder="Full Name" required class="w-full p-3 border bg-gray-50 text-sm outline-none">
                        <div class="grid grid-cols-2 gap-3">
                            <input type="text" id="c-phone" placeholder="Phone" required class="w-full p-3 border bg-gray-50 text-sm outline-none">
                            <input type="email" id="c-email" placeholder="Email" required class="w-full p-3 border bg-gray-50 text-sm outline-none">
                        </div>
                        
                        <!-- Hidden Delivery Fields -->
                        <div id="del-fields" class="hidden space-y-3 pt-2 border-t">
                            <input type="text" id="addr-full" placeholder="House / Street / Brgy / City" class="w-full p-3 border bg-gray-50 text-sm outline-none">
                            <select id="addr-region" onchange="calcTotal()" class="w-full p-3 border bg-gray-50 text-sm outline-none">
                                <option value="" disabled selected>Select Region</option>
                                <option value="Metro Manila">Metro Manila (₱90)</option>
                                <option value="Luzon">Luzon (₱150)</option>
                                <option value="Visayas">Visayas (₱210)</option>
                                <option value="Mindanao">Mindanao (₱220)</option>
                            </select>
                        </div>
                    </div>

                    <!-- Payment -->
                    <div class="bg-gray-50 p-4 border rounded mb-6">
                        <div class="flex justify-between items-center mb-3">
                            <span class="font-bold text-sm">GCash Payment</span>
                            <span class="text-xs bg-blue-600 text-white px-2 py-1 rounded">0976-551-3716</span>
                        </div>
                        <input type="text" id="pay-ref" placeholder="Reference No." required class="w-full p-3 border bg-white text-sm outline-none mb-3">
                        <label class="block w-full text-center border-2 border-dashed p-4 cursor-pointer hover:bg-white transition">
                            <span class="text-xs text-gray-500"><i class="fas fa-camera mr-2"></i>Upload Screenshot</span>
                            <input type="file" id="pay-proof" accept="image/*" class="hidden" required onchange="this.parentElement.classList.add('border-primary')">
                        </label>
                    </div>

                    <!-- Totals -->
                    <div class="border-t pt-4">
                        <div class="flex justify-between text-sm mb-1"><span>Subtotal</span><span id="sum-sub">₱0</span></div>
                        <div class="flex justify-between text-sm mb-1"><span>Delivery</span><span id="sum-ship">₱0</span></div>
                        <div class="flex justify-between text-sm mb-1 text-green-700"><span>Donation</span><span id="sum-don">₱0</span></div>
                        <div class="flex justify-between text-xl font-bold text-primary mt-2 pt-2 border-t"><span>Total</span><span id="sum-total">₱0</span></div>
                    </div>

                    <button type="submit" id="btn-submit" class="w-full bg-primary text-white py-4 mt-6 font-bold uppercase text-sm shadow-lg hover:bg-primary/90 transition">Place Order</button>
                </form>
            </div>
        </div>

    </main>

    <!-- MODALS -->
    
    <!-- Track Order -->
    <div id="modal-track" class="fixed inset-0 bg-black/80 z-[100] hidden flex items-center justify-center p-4" onclick="document.getElementById('modal-track').classList.add('hidden')">
        <div class="bg-white w-full max-w-md p-6 rounded-lg relative" onclick="event.stopPropagation()">
            <h3 class="font-serif text-xl font-bold text-center mb-4">Track Order</h3>
            <div class="flex gap-2 mb-4">
                <input type="text" id="track-id" placeholder="Order ID (e.g. ALJ-12345)" class="flex-1 border p-2 text-sm outline-none">
                <button onclick="doTrack()" class="bg-primary text-white px-4 text-sm font-bold">Find</button>
            </div>
            <div id="track-result" class="text-center text-sm"></div>
        </div>
    </div>

    <!-- Reviews -->
    <div id="modal-reviews" class="fixed inset-0 bg-black/80 z-[100] hidden flex items-center justify-center p-4" onclick="document.getElementById('modal-reviews').classList.add('hidden')">
        <div class="bg-white w-full max-w-lg h-[80vh] rounded-lg relative flex flex-col" onclick="event.stopPropagation()">
            <div class="p-4 border-b flex justify-between items-center bg-gray-50">
                <h3 class="font-bold text-primary">Reviews</h3>
                <button onclick="document.getElementById('modal-reviews').classList.add('hidden')"><i class="fas fa-times"></i></button>
            </div>
            <div id="reviews-list" class="flex-1 overflow-y-auto p-4 space-y-4"></div>
            <div class="p-4 border-t bg-gray-50">
                <form onsubmit="postReview(event)">
                    <div class="flex gap-2 mb-2 justify-center text-xl text-gray-300">
                        <input type="radio" name="rate" value="1"> 1
                        <input type="radio" name="rate" value="2"> 2
                        <input type="radio" name="rate" value="3"> 3
                        <input type="radio" name="rate" value="4"> 4
                        <input type="radio" name="rate" value="5"> 5
                    </div>
                    <input id="rev-name" placeholder="Name" required class="w-full mb-2 p-2 text-sm border">
                    <textarea id="rev-msg" placeholder="Message" required class="w-full mb-2 p-2 text-sm border"></textarea>
                    <button class="w-full bg-primary text-white py-2 text-xs font-bold uppercase">Submit Review</button>
                </form>
            </div>
        </div>
    </div>

    <!-- Hidden Receipt -->
    <div id="receipt-render-area">
        <div class="text-center border-b border-dashed border-black pb-2 mb-2">
            <h2 class="font-bold text-xl">AL-JAZAA PH</h2>
            <div class="text-xs">Halal. Modest. Elegant.</div>
        </div>
        <div id="rec-meta" class="text-xs mb-2 space-y-1"></div>
        <div class="border-b border-dashed border-black mb-2"></div>
        <div id="rec-items" class="text-xs space-y-1 mb-2"></div>
        <div class="border-t border-dashed border-black pt-2 flex justify-between font-bold text-sm">
            <span>TOTAL PAID</span><span id="rec-total"></span>
        </div>
    </div>

    <!-- SCRIPT -->
    <script>
        let allProducts = [], cart = JSON.parse(localStorage.getItem('alj_cart')) || [];
        let curProduct = {}, bundleQty = 1, donationPct = 0;

        document.addEventListener("DOMContentLoaded", () => {
            fetchProducts();
            updateCartBadge();
            // Handle browser back button
            window.onpopstate = (e) => {
                if(e.state) renderPage(e.state.page); else renderPage('home');
            };
        });

        function routeTo(page) {
            window.history.pushState({page}, '', '');
            renderPage(page);
        }

        function renderPage(page) {
            window.scrollTo(0,0);
            document.querySelectorAll('.view-section').forEach(el => el.classList.add('hidden'));
            
            if (page === 'home') document.getElementById('page-home').classList.remove('hidden');
            else if (page === 'grid') { document.getElementById('page-grid').classList.remove('hidden'); renderGrid(allProducts); }
            else if (page === 'detail') document.getElementById('page-detail').classList.remove('hidden');
            else if (page === 'cart') { document.getElementById('page-cart').classList.remove('hidden'); renderCart(); }
            else if (page === 'checkout') { 
                if(cart.length === 0) routeTo('home');
                else { document.getElementById('page-checkout').classList.remove('hidden'); calcTotal(); }
            }
        }

        // --- DATA ---
        function fetchProducts() {
            fetch(WEB_APP_URL + "?action=getProducts").then(r => r.json()).then(data => {
                allProducts = data;
                document.getElementById('loader').classList.add('hidden');
                
                // Render Home Categories Dynamic from Sheet
                const cats = [...new Set(data.map(p => p.category))];
                document.getElementById('home-cat-list').innerHTML = cats.map(c => 
                    `<button onclick="filterCat('${c}')" class="shrink-0 bg-white border border-gray-200 px-6 py-3 rounded text-sm font-bold uppercase text-gray-600 hover:border-primary hover:text-primary transition">${c}</button>`
                ).join('');

                // Render Filter Bar on Grid
                document.getElementById('filter-bar').innerHTML = 
                    `<button onclick="renderGrid(allProducts)" class="text-xs uppercase font-bold text-gray-500 hover:text-primary">All</button>` + 
                    cats.map(c => `<button onclick="filterCat('${c}')" class="text-xs uppercase font-bold text-gray-500 hover:text-primary">${c}</button>`).join('');

                renderGrid(data);
                
                // New Arrivals (Last 6)
                const newItems = [...data].reverse().slice(0, 6);
                document.getElementById('home-products').innerHTML = newItems.map(p => productCard(p, true)).join('');

                // Reviews
                fetch(WEB_APP_URL + "?action=getReviews").then(r=>r.json()).then(revs => renderReviews(revs));
            });
        }

        function productCard(p, minimal = false) {
            return `
            <div onclick="openDetail('${p.id}')" class="${minimal ? 'shrink-0 w-40' : 'w-full'} cursor-pointer group">
                <div class="aspect-[3/4] bg-gray-100 overflow-hidden relative mb-2 border border-gray-100">
                    <img src="${p.image}" class="w-full h-full object-cover group-hover:scale-105 transition duration-500">
                    ${p.salePercent > 0 ? `<span class="absolute top-1 left-1 bg-secondary text-white text-[9px] px-2 py-0.5 font-bold">-${p.salePercent}%</span>` : ''}
                </div>
                <div class="px-1">
                    <h4 class="font-serif text-sm font-bold truncate text-primary">${p.name}</h4>
                    <div class="flex gap-2 items-center">
                        <span class="text-xs font-bold">₱${p.price}</span>
                        ${p.salePercent > 0 ? `<span class="text-[10px] text-gray-400 line-through">₱${p.originalPrice}</span>` : ''}
                    </div>
                </div>
            </div>`;
        }

        function filterCat(cat) {
            const filtered = allProducts.filter(p => p.category === cat);
            document.getElementById('grid-title').innerText = cat;
            renderGrid(filtered);
            routeTo('grid');
        }

        function renderGrid(list) {
            document.getElementById('product-grid').innerHTML = list.map(p => productCard(p)).join('');
        }

        function doSearch() {
            const q = document.getElementById('searchBox').value.toLowerCase();
            const res = allProducts.filter(p => p.name.toLowerCase().includes(q) || p.category.toLowerCase().includes(q));
            renderGrid(res);
        }

        // --- DETAILS ---
        function openDetail(id) {
            curProduct = allProducts.find(p => p.id == id);
            bundleQty = 1;
            
            document.getElementById('dt-img').src = curProduct.image;
            document.getElementById('dt-name').innerText = curProduct.name;
            document.getElementById('dt-cat').innerText = curProduct.category;
            document.getElementById('dt-desc').innerText = curProduct.desc || "No description.";
            document.getElementById('dt-price').innerText = "₱" + curProduct.price;
            
            if(curProduct.salePercent > 0) {
                document.getElementById('dt-badge').classList.remove('hidden');
                document.getElementById('dt-old-price').classList.remove('hidden');
                document.getElementById('dt-old-price').innerText = "₱" + curProduct.originalPrice;
            } else {
                document.getElementById('dt-badge').classList.add('hidden');
                document.getElementById('dt-old-price').classList.add('hidden');
            }

            const imgs = curProduct.images || [curProduct.image];
            document.getElementById('dt-gallery').innerHTML = imgs.map(src => `<img src="${src}" onclick="document.getElementById('dt-img').src='${src}'" class="w-14 h-16 object-cover border cursor-pointer hover:border-primary">`).join('');

            // Options
            const sizes = ['S','M','L','XL','Free Size'];
            document.getElementById('size-opts').innerHTML = sizes.map(s => `<button class="opt-btn size border px-3 py-1 text-xs hover:border-primary" onclick="selOpt(this, 'size', '${s}')">${s}</button>`).join('');
            
            const colors = curProduct.colors ? curProduct.colors.split(',') : ['Standard'];
            document.getElementById('color-opts').innerHTML = colors.map(c => `<button class="opt-btn color border px-3 py-1 text-xs hover:border-primary" onclick="selOpt(this, 'color', '${c.trim()}')">${c.trim()}</button>`).join('');
            
            document.getElementById('dt-height').value = '';
            curProduct.selSize = null; curProduct.selColor = null;
            checkAdd();
            routeTo('detail');
        }

        function selOpt(el, type, val) {
            document.querySelectorAll(`.opt-btn.${type}`).forEach(b => { b.classList.remove('bg-primary','text-white'); b.classList.add('border-gray-200'); });
            el.classList.remove('border-gray-200'); el.classList.add('bg-primary', 'text-white');
            if(type==='size') curProduct.selSize = val; else curProduct.selColor = val;
            checkAdd();
        }

        function setBundle(q, el) {
            bundleQty = q;
            document.querySelectorAll('.bundle-btn').forEach(b => b.classList.remove('bg-primary', 'text-white'));
            el.classList.add('bg-primary', 'text-white');
        }

        function checkAdd() {
            const btn = document.getElementById('btn-add');
            btn.disabled = !(curProduct.selSize && curProduct.selColor);
        }

        function addToCart() {
            let unitPrice = curProduct.price;
            if(bundleQty === 2) unitPrice = unitPrice * 0.95;
            if(bundleQty === 3) unitPrice = unitPrice * 0.90;
            
            cart.push({
                ...curProduct,
                size: curProduct.selSize,
                color: curProduct.selColor,
                height: document.getElementById('dt-height').value,
                qty: bundleQty,
                price: Math.ceil(unitPrice)
            });
            localStorage.setItem('alj_cart', JSON.stringify(cart));
            updateCartBadge();
            Swal.fire({icon:'success', title:'Added to bag', toast:true, position:'top-end', showConfirmButton:false, timer:1000});
            window.history.back();
        }

        function updateCartBadge() { document.getElementById('cart-count').innerText = cart.length; }

        // --- CART ---
        function renderCart() {
            const list = document.getElementById('cart-list');
            if(cart.length === 0) {
                list.innerHTML = '<div class="text-center text-gray-500 py-10">Cart is empty.</div>';
                document.getElementById('cart-summary').classList.add('hidden');
            } else {
                document.getElementById('cart-summary').classList.remove('hidden');
                let total = 0;
                list.innerHTML = cart.map((i, idx) => {
                    total += i.price * i.qty;
                    return `
                    <div class="flex gap-4 border-b pb-4">
                        <img src="${i.image}" class="w-16 h-20 object-cover bg-gray-50">
                        <div class="flex-1">
                            <div class="flex justify-between">
                                <h4 class="font-bold text-sm text-gray-800">${i.name}</h4>
                                <button onclick="remItem(${idx})" class="text-red-400 text-xs"><i class="fas fa-trash"></i></button>
                            </div>
                            <div class="text-xs text-gray-500">${i.size} | ${i.color}</div>
                            <div class="flex justify-between mt-2">
                                <span class="text-xs bg-gray-100 px-2 py-1">Qty: ${i.qty}</span>
                                <span class="font-bold text-primary">₱${i.price * i.qty}</span>
                            </div>
                        </div>
                    </div>`;
                }).join('');
                document.getElementById('cart-total-display').innerText = "₱" + total.toLocaleString();
            }
        }

        function remItem(i) { cart.splice(i,1); localStorage.setItem('alj_cart', JSON.stringify(cart)); updateCartBadge(); renderCart(); }

        // --- CHECKOUT ---
        function toggleDelivery() {
            const m = document.getElementById('del-method').value;
            const f = document.getElementById('del-fields');
            if(m === 'Delivery') {
                f.classList.remove('hidden');
                document.getElementById('addr-full').required = true;
                document.getElementById('addr-region').required = true;
            } else {
                f.classList.add('hidden');
                document.getElementById('addr-full').required = false;
                document.getElementById('addr-region').required = false;
            }
            calcTotal();
        }

        function setDonation(p, el) {
            donationPct = p;
            document.querySelectorAll('.don-btn').forEach(b => { b.classList.remove('bg-primary','text-white'); b.classList.add('bg-white','text-primary'); });
            el.classList.remove('bg-white','text-primary'); el.classList.add('bg-primary','text-white');
            if(p > 0) document.getElementById('don-note').classList.remove('hidden'); else document.getElementById('don-note').classList.add('hidden');
            calcTotal();
        }

        function calcTotal() {
            let sub = cart.reduce((a,b)=>a+(b.price*b.qty),0);
            let ship = 0;
            if(document.getElementById('del-method').value === 'Delivery') {
                const r = document.getElementById('addr-region').value;
                if(sub < 3000) { // Free ship threshold
                    if(r.includes('Manila')) ship = 90;
                    else if(r.includes('Luzon')) ship = 150;
                    else if(r.includes('Visayas')) ship = 210;
                    else if(r.includes('Mindanao')) ship = 220;
                }
            }
            let don = Math.ceil(sub * donationPct);
            let total = sub + ship + don;

            document.getElementById('sum-sub').innerText = "₱" + sub.toLocaleString();
            document.getElementById('sum-ship').innerText = "₱" + ship;
            document.getElementById('sum-don').innerText = "₱" + don;
            document.getElementById('sum-total').innerText = "₱" + total.toLocaleString();
            
            return { sub, ship, don, total };
        }

        function submitOrder(e) {
            e.preventDefault();
            const btn = document.getElementById('btn-submit');
            btn.innerText = "Processing..."; btn.disabled = true;

            const file = document.getElementById('pay-proof').files[0];
            const reader = new FileReader();
            
            reader.onload = function(evt) {
                const calcs = calcTotal();
                const address = document.getElementById('del-method').value === 'Delivery' ? 
                    document.getElementById('addr-full').value : "Pick-up";
                
                const payload = {
                    action: 'placeOrder',
                    cust: {
                        name: document.getElementById('c-name').value,
                        phone: document.getElementById('c-phone').value,
                        email: document.getElementById('c-email').value,
                        addr: address
                    },
                    pay: {
                        ref: document.getElementById('pay-ref').value,
                        image: evt.target.result,
                        mime: file.type
                    },
                    cart: cart,
                    total: "₱" + calcs.total.toLocaleString(),
                    donation: { 
                        info: donationPct > 0 ? `₱${calcs.don} (${donationPct*100}%)` : "None", 
                        note: document.getElementById('don-note').value 
                    },
                    delivery: {
                        method: document.getElementById('del-method').value,
                        region: document.getElementById('addr-region').value || "N/A",
                        fee: calcs.ship
                    }
                };

                fetch(WEB_APP_URL, { method: 'POST', body: JSON.stringify(payload) })
                .then(r => r.json()).then(d => {
                    if(d.status === 'success') {
                        // Generate Receipt
                        document.getElementById('rec-meta').innerHTML = `Date: ${new Date().toLocaleDateString()}<br>Order ID: ${d.orderId}<br>Name: ${payload.cust.name}`;
                        document.getElementById('rec-items').innerHTML = cart.map(i => `<div class="flex justify-between"><span>${i.qty}x ${i.name}</span><span>${i.price*i.qty}</span></div>`).join('');
                        document.getElementById('rec-total').innerText = payload.total;
                        
                        html2canvas(document.getElementById('receipt-render-area')).then(canvas => {
                            const link = document.createElement('a');
                            link.download = `ALJ-Receipt-${d.orderId}.png`;
                            link.href = canvas.toDataURL();
                            link.click();
                            
                            cart = []; localStorage.setItem('alj_cart', '[]');
                            Swal.fire({icon: 'success', title: 'Order Placed!', text: 'Receipt downloaded.', confirmButtonColor:'#1b4d3e'}).then(() => window.location.reload());
                        });
                    } else {
                        Swal.fire('Error', d.error, 'error');
                        btn.innerText = "Place Order"; btn.disabled = false;
                    }
                });
            };
            reader.readAsDataURL(file);
        }

        // --- TRACK & REVIEWS ---
        function doTrack() {
            const id = document.getElementById('track-id').value;
            fetch(`${WEB_APP_URL}?action=trackOrder&orderId=${id}`).then(r=>r.json()).then(d => {
                const div = document.getElementById('track-result');
                if(d.status === 'found') div.innerHTML = `<div class="mt-4 p-4 bg-green-50 text-green-800 rounded"><div class="font-bold text-lg">${d.currStatus}</div><div>Total: ${d.total}</div><div class="text-xs text-gray-500">${d.date}</div></div>`;
                else div.innerHTML = `<div class="mt-4 text-red-500">Order ID not found.</div>`;
            });
        }

        function openModal(id) { document.getElementById('modal-'+id).classList.remove('hidden'); }

        function renderReviews(list) {
            const html = list.length ? list.map(r => `
                <div class="bg-white p-4 border rounded shadow-sm">
                    <div class="flex justify-between mb-1"><span class="font-bold text-sm">${r.name}</span><span class="text-secondary text-xs">${'★'.repeat(r.rating)}</span></div>
                    <p class="text-xs text-gray-600 italic">"${r.feedback}"</p>
                </div>`).join('') : '<p class="text-center text-gray-400 text-sm">No reviews yet.</p>';
            
            document.getElementById('reviews-list').innerHTML = html;
            document.getElementById('home-reviews').innerHTML = list.length ? `"${list[0].feedback}"` : "Quality speaks for itself.";
        }

        function postReview(e) {
            e.preventDefault();
            let rating = 0; document.querySelectorAll('input[name="rate"]').forEach(r => { if(r.checked) rating = r.value; });
            if(rating == 0) return Swal.fire('Rating required', '', 'warning');
            
            const payload = {
                action: 'submitReview',
                name: document.getElementById('rev-name').value,
                email: 'web-user',
                feedback: document.getElementById('rev-msg').value,
                rating: rating
            };
            fetch(WEB_APP_URL, {method:'POST', body:JSON.stringify(payload)}).then(r=>r.json()).then(() => {
                Swal.fire('Thank you!', 'Review submitted.', 'success');
                document.getElementById('modal-reviews').classList.add('hidden');
            });
        }
    </script>
</body>
</html>
